<!DOCTYPE html>
<html>
	<head>
		<link rel="manifest" href="/manifest.json">
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Nabodega Virtual é um projeto para virtaulização de sepermercados">
		<meta name="author" content="Cleirton Viana">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">
		<style id="bootstrapcss"></style>
		<style id="styles"></style>
		<script id="jquery"></script>
		<script id="bootstrapjs"></script>
		<script id="socketio"></script>
		<script id="scripts"></script>
	</head>
	<body >
		
		<div id="homepage"></div>
		<div id="root"></div>
		
		<div id="painel">
			
			<div id="mensagens" class="container-fluid">
				<div class="row sombra" id="onlines"></div>
				<div class="row sombra" id="usuario"></div>
				<br>
				<div class="row">
					<h4 class="col-xs-12 sombra">Bate-papo:</h4>
					<form onsubmit="sendMSG();return false;"><input type="text" class="col-xs-10" id="sendmsg" />
					<input type="submit" class="col-xs-2" value=">"/></form>
				</div>
				<ul class="col-xs-12 list-group"></ul>
			</div>
			<br><br>
			<button onclick="localStorage.clear();location.reload();">Limpar</button>
		</div>
		
		<script>
			var timer;
			var status =0;
			function isload(){
				if (status == 0){
					for (let index = 1; index < localStorage.length-2; index++) {
						var campos  = localStorage.getItem("f"+index).split("£");  
						if(campos.length==2)            
						var element = eval ("(" + "document.getElementById('"+campos[0]+"').innerHTML="+ JSON.stringify(campos[1])+")");
					}
				}
				if(status != localStorage.getItem("load")){
					status=localStorage.getItem("load")
					var myFunc = eval('(' + localStorage.getItem("load") + ')');
				}
				
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200 && xhttp.responseText != 'null') {
						try{
							var campos = xhttp.responseText.split("£");
							if(campos.length==2) {
								localStorage.setItem("f"+localStorage.getItem("func"), xhttp.responseText);
								var element = eval ("(" + "document.getElementById('"+campos[0]+"').innerHTML="+ JSON.stringify(campos[1])+")");
								localStorage.setItem("func", parseInt(localStorage.getItem("func")) + 1);
							}
							}catch(ex){
							location.reload();
						}     
						
						clearTimeout(timer);
						timer = setTimeout(() => {
							console.log("Verificando a função: "+ localStorage.getItem("func"));
							isload();
						}, 1);
						
						}else if(this.readyState == 4 && this.status == 304){
						localStorage.setItem("load", "console.log('Sistema atualizado!')");
						
						clearTimeout(timer);
						timer = setTimeout(() => {
							isload();
						}, 10000);
						
						} else{
						localStorage.setItem("load", "console.log('Erro ao atualizar o sistema!')");
						
						clearTimeout(timer);
						timer = setTimeout(() => {
							isload();
						}, 10000);
						
					}
				};
				xhttp.open("GET", "/func/"+ localStorage.getItem("func"), true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send({ form: 'data',func: localStorage.getItem("func")});
			}
			
			if (typeof(Storage) !== "undefined") {
				if (!localStorage.getItem("load")){
					localStorage.setItem("username","Desconhecido");
					localStorage.setItem("load", "console.log('Aguarde enquanto a estrutura desta aplicação é instalada')");
					localStorage.setItem("func", "1");
				}
				window.onload = isload();
				} else {
				console.log("Seu navegador não suporta o LocalStorage");
			}
		</script>
	</body>
</html>